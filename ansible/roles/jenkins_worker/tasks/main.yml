---
# =========================
# Update system
# =========================
- name: Update apt cache
  apt:
    update_cache: yes
  become: yes
  tags:
    - jenkins_worker
    - packages

# =========================
# Remove old Java (clean)
# =========================
- name: Remove old Java versions
  apt:
    name:
      - openjdk-11-jdk
      - openjdk-17-jdk
    state: absent
  become: yes
  tags:
    - jenkins_worker
    - java

# =========================
# Install Java 21 + Maven
# =========================
- name: Install Java 21 and build tools
  apt:
    name:
      - openjdk-21-jdk
      - maven
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
  become: yes
  tags:
    - jenkins_worker
    - java
    - maven

# =========================
# Set Java 21 as default
# =========================
- name: Set Java 21 as default
  alternatives:
    name: java
    path: /usr/lib/jvm/java-21-openjdk-amd64/bin/java
  become: yes
  tags:
    - jenkins_worker
    - java

- name: Set Javac 21 as default
  alternatives:
    name: javac
    path: /usr/lib/jvm/java-21-openjdk-amd64/bin/javac
  become: yes
  tags:
    - jenkins_worker
    - java

# =========================
# Docker permission
# =========================
- name: Ensure docker group exists
  group:
    name: docker
    state: present
  become: yes
  tags:
    - jenkins_worker
    - docker

- name: Add ubuntu user to docker group
  user:
    name: ubuntu
    groups: docker
    append: yes
  become: yes
  tags:
    - jenkins_worker
    - docker

# =========================
# Jenkins agent workspace
# =========================
- name: Create Jenkins agent directory
  file:
    path: /home/ubuntu/jenkins-agent
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  become: yes
  tags:
    - jenkins_worker
    - workspace
